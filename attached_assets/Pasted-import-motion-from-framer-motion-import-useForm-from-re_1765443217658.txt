import { motion } from "framer-motion";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Upload, User, Shield, Zap, Target, Swords, Crosshair, HeartPulse, CheckCircle2 } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Separator } from "@/components/ui/separator";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import heroBg from "@assets/generated_images/background_for_mlbb_tournament_form.png";
import playerPlaceholder from "@assets/playertemp_1765386122888.png";
import { Toaster } from "@/components/ui/sonner";
import { toast } from "sonner";

// --- Schema Definition ---
const playerSchema = z.object({
  name: z.string().min(2, "Name is required"),
  ign: z.string().min(2, "IGN is required"),
  id: z.string().min(4, "ID is required"),
  role: z.string().min(1, "Role is required"),
  photo: z.any().optional(), // File handling is tricky in pure frontend validation without custom logic
});

const formSchema = z.object({
  teamName: z.string().min(2, "Team Name is required"),
  teamTag: z.string().min(2, "Team Tag is required"),
  region: z.string().min(1, "Region is required"),
  teamLogo: z.any().optional(),
  captain: z.object({
    name: z.string().min(2, "Required"),
    ign: z.string().min(2, "Required"),
    id: z.string().min(4, "Required"),
    email: z.string().email("Invalid email"),
    phone: z.string().min(10, "Invalid phone"),
  }),
  coLeader: z.object({
    name: z.string().min(2, "Required"),
    ign: z.string().min(2, "Required"),
    id: z.string().min(4, "Required"),
    email: z.string().email("Invalid email"),
    phone: z.string().min(10, "Invalid phone"),
  }),
  players: z.array(playerSchema),
  declaration: z.boolean().refine((val) => val === true, "You must agree to the declaration"),
});

// --- Components ---

const SectionTitle = ({ children, icon: Icon }: { children: React.ReactNode; icon?: any }) => (
  <div className="relative mb-8 mt-12">
    <div className="absolute -left-4 top-1/2 -translate-y-1/2 w-1 h-12 bg-primary shadow-[0_0_15px_rgba(6,182,212,0.8)] rounded-full" />
    <h2 className="text-3xl font-orbitron font-bold text-white uppercase tracking-widest flex items-center gap-3">
      {Icon && <Icon className="w-8 h-8 text-primary animate-pulse" />}
      <span className="bg-clip-text text-transparent bg-gradient-to-r from-white to-white/70">{children}</span>
    </h2>
    <div className="h-[2px] w-full bg-gradient-to-r from-primary/50 to-transparent mt-2" />
  </div>
);

const GlassCard = ({ children, className = "" }: { children: React.ReactNode; className?: string }) => (
  <motion.div
    initial={{ opacity: 0, y: 20 }}
    whileInView={{ opacity: 1, y: 0 }}
    viewport={{ once: true, margin: "-50px" }}
    transition={{ duration: 0.5 }}
    className={`glass-panel rounded-2xl p-6 md:p-8 relative overflow-hidden ${className}`}
  >
    <div className="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
      <Shield className="w-32 h-32" />
    </div>
    {children}
  </motion.div>
);

const RoleIcon = ({ role }: { role: string }) => {
  switch (role.toLowerCase()) {
    case "tank": return <Shield className="w-4 h-4" />;
    case "fighter": return <Swords className="w-4 h-4" />;
    case "assassin": return <Crosshair className="w-4 h-4" />;
    case "mage": return <Zap className="w-4 h-4" />;
    case "marksman": return <Target className="w-4 h-4" />;
    case "support": return <HeartPulse className="w-4 h-4" />;
    default: return <User className="w-4 h-4" />;
  }
};

export default function Registration() {
  const form = useForm<z.infer<typeof formSchema>>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      teamName: "",
      teamTag: "",
      region: "",
      captain: { name: "", ign: "", id: "", email: "", phone: "" },
      coLeader: { name: "", ign: "", id: "", email: "", phone: "" },
      players: Array(5).fill({ name: "", ign: "", id: "", role: "", photo: null }),
      declaration: false,
    },
  });

  function onSubmit(values: z.infer<typeof formSchema>) {
    console.log(values);
    toast.success("Registration Submitted Successfully!", {
        description: "Your team has been registered for the Battle Realm Series 2.",
    });
    // In a real app, you would POST this data to your backend or Formspree here.
    // Since this is a UI prototype, we just show the success state.
  }

  return (
    <div className="min-h-screen relative w-full overflow-x-hidden text-white selection:bg-primary/30">
      {/* Background Image & Overlay */}
      <div className="fixed inset-0 z-[-1]">
        <img 
          src={heroBg} 
          alt="Battle Background" 
          className="w-full h-full object-cover opacity-60"
        />
        <div className="absolute inset-0 bg-gradient-to-b from-background/90 via-background/80 to-background/95" />
        <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 brightness-100 contrast-150 mix-blend-overlay" />
      </div>

      <div className="container mx-auto px-4 py-12 md:py-24 max-w-5xl relative z-10">
        
        {/* Header */}
        <motion.div 
          initial={{ opacity: 0, y: -30 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.8 }}
          className="text-center mb-20"
        >
          <div className="inline-block mb-6 relative group">
            <div className="absolute -inset-1 bg-gradient-to-r from-primary via-purple-500 to-primary rounded-lg blur opacity-40 group-hover:opacity-75 transition duration-1000 group-hover:duration-200 animate-tilt"></div>
            <div className="relative px-6 py-2 bg-black rounded-lg leading-none flex items-center">
              <span className="font-orbitron font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary to-purple-400">
                IPEORG OFFICIAL TOURNAMENT
              </span>
            </div>
          </div>
          
          <h1 className="text-5xl md:text-7xl font-orbitron font-black uppercase tracking-tight mb-4 neon-text-cyan">
            Battle Realm
            <span className="block text-3xl md:text-4xl text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 mt-2">
              Series 2
            </span>
          </h1>
          
          <p className="text-xl text-muted-foreground font-rajdhani max-w-2xl mx-auto mt-6">
            Gather your squad. Dominate the lane. Become Legends.
            <br/>
            <span className="text-primary/80">Registration ends soon.</span>
          </p>
        </motion.div>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-12">
            
            {/* Team Info */}
            <section>
              <SectionTitle icon={Shield}>Team Information</SectionTitle>
              <GlassCard className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <FormField
                  control={form.control}
                  name="teamName"
                  render={({ field }) => (
                    <FormItem className="col-span-1 md:col-span-2">
                      <FormLabel className="text-primary font-bold">Team Name</FormLabel>
                      <FormControl>
                        <Input placeholder="Enter your team name" {...field} className="glass-input h-12 text-lg" />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                <FormField
                  control={form.control}
                  name="teamTag"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel className="text-primary font-bold">Team Tag</FormLabel>
                      <FormControl>
                        <Input placeholder="e.g. [IPE]" {...field} className="glass-input h-12" />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                <FormField
                  control={form.control}
                  name="region"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel className="text-primary font-bold">Region</FormLabel>
                      <Select onValueChange={field.onChange} defaultValue={field.value}>
                        <FormControl>
                          <SelectTrigger className="glass-input h-12">
                            <SelectValue placeholder="Select Region" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent className="bg-black/90 border-primary/20 text-white">
                          <SelectItem value="india">India</SelectItem>
                          <SelectItem value="sea">SEA</SelectItem>
                          <SelectItem value="others">Others</SelectItem>
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                <FormField
                  control={form.control}
                  name="teamLogo"
                  render={({ field: { value, onChange, ...fieldProps } }) => (
                    <FormItem className="col-span-1 md:col-span-2">
                      <FormLabel className="text-primary font-bold">Team Logo</FormLabel>
                      <FormControl>
                        <div className="border-2 border-dashed border-white/20 rounded-xl p-8 text-center hover:border-primary/50 transition-colors cursor-pointer bg-white/5 relative">
                          <Upload className="w-8 h-8 mx-auto mb-2 text-muted-foreground" />
                          <span className="text-sm text-muted-foreground">Click to upload logo (PNG/JPG)</span>
                          <Input
                            {...fieldProps}
                            type="file"
                            className="absolute inset-0 opacity-0 cursor-pointer"
                            accept="image/*"
                            onChange={(event) => {
                              onChange(event.target.files && event.target.files[0]);
                            }}
                          />
                        </div>
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </GlassCard>
            </section>

            {/* Captain & Co-Leader */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <section>
                <SectionTitle icon={User}>Team Captain</SectionTitle>
                <GlassCard className="space-y-4">
                  {["name", "ign", "id", "email", "phone"].map((key) => (
                    <FormField
                      key={`captain-${key}`}
                      control={form.control}
                      name={`captain.${key}` as any}
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel className="capitalize text-primary/90">{key === "id" ? "MLBB ID" : key === "ign" ? "In-Game Name" : key}</FormLabel>
                          <FormControl>
                            <Input {...field} className="glass-input" />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  ))}
                </GlassCard>
              </section>

              <section>
                <SectionTitle icon={User}>Co-Leader</SectionTitle>
                <GlassCard className="space-y-4">
                  {["name", "ign", "id", "email", "phone"].map((key) => (
                    <FormField
                      key={`coleader-${key}`}
                      control={form.control}
                      name={`coLeader.${key}` as any}
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel className="capitalize text-primary/90">{key === "id" ? "MLBB ID" : key === "ign" ? "In-Game Name" : key}</FormLabel>
                          <FormControl>
                            <Input {...field} className="glass-input" />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  ))}
                </GlassCard>
              </section>
            </div>

            {/* Players */}
            <section>
              <SectionTitle icon={Swords}>Main Roster</SectionTitle>
              <div className="space-y-6">
                {[0, 1, 2, 3, 4].map((index) => (
                  <GlassCard key={index} className="border-l-4 border-l-primary/50">
                    <div className="flex items-center gap-4 mb-6">
                      <div className="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center font-orbitron font-bold text-primary border border-primary/30">
                        {index + 1}
                      </div>
                      <h3 className="text-xl font-orbitron text-white">Player {index + 1}</h3>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                      <FormField
                        control={form.control}
                        name={`players.${index}.photo`}
                        render={({ field: { value, onChange, ...fieldProps } }) => (
                          <FormItem className="col-span-1 row-span-2 md:row-span-1 lg:row-span-1 flex justify-center items-center">
                             <FormControl>
                                <div className="relative group cursor-pointer">
                                  <div className="w-24 h-24 rounded-full overflow-hidden border-2 border-primary/30 group-hover:border-primary transition-all shadow-[0_0_15px_rgba(6,182,212,0.2)]">
                                    <img 
                                      src={value ? URL.createObjectURL(value) : playerPlaceholder} 
                                      alt="Player" 
                                      className="w-full h-full object-cover"
                                    />
                                    <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                      <Upload className="w-6 h-6 text-white" />
                                    </div>
                                  </div>
                                  <Input
                                    {...fieldProps}
                                    type="file"
                                    className="absolute inset-0 opacity-0 cursor-pointer"
                                    accept="image/*"
                                    onChange={(event) => {
                                      onChange(event.target.files && event.target.files[0]);
                                    }}
                                  />
                                </div>
                             </FormControl>
                             <FormMessage />
                          </FormItem>
                        )}
                      />

                      <FormField
                        control={form.control}
                        name={`players.${index}.name`}
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel className="text-xs uppercase tracking-wider text-muted-foreground">Full Name</FormLabel>
                            <FormControl><Input {...field} className="glass-input" /></FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                      <FormField
                        control={form.control}
                        name={`players.${index}.ign`}
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel className="text-xs uppercase tracking-wider text-muted-foreground">IGN</FormLabel>
                            <FormControl><Input {...field} className="glass-input" /></FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                      <FormField
                        control={form.control}
                        name={`players.${index}.id`}
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel className="text-xs uppercase tracking-wider text-muted-foreground">MLBB ID</FormLabel>
                            <FormControl><Input {...field} className="glass-input" /></FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                      <FormField
                        control={form.control}
                        name={`players.${index}.role`}
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel className="text-xs uppercase tracking-wider text-muted-foreground">Role</FormLabel>
                            <Select onValueChange={field.onChange} defaultValue={field.value}>
                              <FormControl>
                                <SelectTrigger className="glass-input">
                                  <SelectValue placeholder="Role" />
                                </SelectTrigger>
                              </FormControl>
                              <SelectContent className="bg-black/90 border-primary/20 text-white">
                                {["Tank", "Fighter", "Assassin", "Mage", "Marksman", "Support"].map(role => (
                                  <SelectItem key={role} value={role}>
                                    <div className="flex items-center gap-2">
                                      <RoleIcon role={role} /> {role}
                                    </div>
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>
                  </GlassCard>
                ))}
              </div>
            </section>

            {/* Declaration */}
            <section className="mt-12">
               <div className="p-8 rounded-2xl border border-dashed border-primary/30 bg-primary/5">
                  <FormField
                    control={form.control}
                    name="declaration"
                    render={({ field }) => (
                      <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                        <FormControl>
                          <Checkbox
                            checked={field.value}
                            onCheckedChange={field.onChange}
                            className="border-primary data-[state=checked]:bg-primary data-[state=checked]:text-black"
                          />
                        </FormControl>
                        <div className="space-y-1 leading-none">
                          <FormLabel className="text-base cursor-pointer">
                            I hereby declare that all the information provided above is true and accurate. I agree to the tournament rules and regulations.
                          </FormLabel>
                          <FormMessage />
                        </div>
                      </FormItem>
                    )}
                  />
               </div>
            </section>

            <Button 
              type="submit" 
              className="w-full h-16 text-2xl font-orbitron font-bold uppercase tracking-widest bg-gradient-to-r from-primary via-cyan-400 to-primary bg-[length:200%_auto] hover:bg-[center_right] transition-all duration-500 rounded-xl shadow-[0_0_30px_rgba(6,182,212,0.4)] hover:shadow-[0_0_50px_rgba(6,182,212,0.6)] text-black"
            >
              Submit Registration
            </Button>

          </form>
        </Form>
      </div>
      <Toaster />
    </div>
  );
}
